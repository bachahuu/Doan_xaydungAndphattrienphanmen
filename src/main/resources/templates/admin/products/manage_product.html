<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="content">
    <div class="container">
        <h1 style="text-align:center; font-family: 'Times New Roman', Times, serif;">Quản Lý Sản Phẩm</h1>

        <div style="text-align:right; margin-right:45px; margin-bottom:10px;">
            <button type="button" class="btn btn-success" onclick="openProductModal(null)">Thêm Sản Phẩm</button>
        </div>

        <div style="margin-bottom:12px;">
            <strong>Số lượng sản phẩm:</strong>
            <span th:text="${sanPhamList != null ? #lists.size(sanPhamList) : 0}">0</span>
        </div>

        <table class="table table-striped">
            <thead>
                <tr style="text-align:center;">
                    <th>STT</th>
                    <th>Mã Sản Phẩm</th>
                    <th>Tên Sản Phẩm</th>
                    <th>Tồn Kho</th>
                    <th>Hình Ảnh</th>
                    <th style="width: 15%;">Thao tác</th> </tr>
                </tr>
            </thead>
            <tbody>
                <tr th:each="sp,iterStat : ${sanPhamList}" style="text-align:center;">
                    <td th:text="${iterStat.count}">1</td>
                    <td th:text="${sp.maSanPham}">SP001</td>
                    <td th:text="${sp.tenSanPham}">Sản phẩm A</td>
                    <td th:text="${sp.soLuongTon}">100</td>
                    <td>
                        <img th:src="@{'/images/' + ${sp.hinhAnh}}" style="width:50px;height:50px;" alt="Hình ảnh sản phẩm"/>
                    </td>
                    <td> <div class="btn-group btn-group-sm" role="group"> <button type="button" class="btn btn-info btn-sm"
                                    th:onclick="'openViewDetailModal(' + ${sp.id} + ')'"
                                    title="Xem chi tiết">
                                <i class="fas fa-eye"></i> </button>
                            <button type="button" class="btn btn-warning btn-sm"
                                    th:onclick="'openProductModal(' + ${sp.id} + ')'"
                                    title="Chỉnh sửa">
                                <i class="fas fa-edit"></i> </button>
                            <button type="button" class="btn btn-danger btn-sm"
                                    th:onclick="'handleDeleteProduct(' + ${sp.id} + ')'"
                                    title="Xóa">
                                <i class="fas fa-trash"></i> </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="productModalLabel">Tiêu đề Modal</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"> 
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="productModalBody">
            <div class="text-center">Đang tải...</div>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // 1. HÀM MỚI: Mở modal xem chi tiết sản phẩm
        function openViewDetailModal(id) {
            const url = '/admin/products/detail/' + id; // Endpoint mới để lấy chi tiết
            $('#productModalLabel').text('Chi Tiết Sản Phẩm');
            
            // Hiển thị loading
            $('#productModalBody').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div> Đang tải thông tin...</div>');
            
            fetch(url) 
            .then(response => {
                if (!response.ok) throw new Error('Lỗi tải chi tiết: ' + response.statusText);
                return response.text(); // Lấy fragment HTML chi tiết
            })
            .then(html => {
                $('#productModalBody').html(html);
                $('#productModal').modal('show'); 
            })
            .catch(error => {
                console.error('Error loading detail:', error);
                $('#productModalBody').html('<div class="alert alert-danger">Lỗi khi tải chi tiết: ' + error.message + '</div>');
                $('#productModal').modal('show');
            });
        }
        
        // 2. HÀM CŨ: Mở modal Thêm/Sửa (Form)
        function openProductModal(id) {
            const url = id ? '/admin/products/form/' + id : '/admin/products/form/new'; 
            $('#productModalLabel').text(id ? 'Sửa Sản Phẩm' : 'Thêm Sản Phẩm Mới');
            
            // Giữ nguyên logic tải form và gắn handler
            $('#productModalBody').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div> Đang tải form...</div>');
            
            fetch(url) 
            .then(response => {
                if (!response.ok) throw new Error('Lỗi tải form: ' + response.statusText);
                return response.text();
            })
            .then(html => {
                $('#productModalBody').html(html);
                $('#productModal').modal('show'); 
                attachFormSubmitHandler(); // Gắn lại handler submit cho form
            })
            .catch(error => {
                console.error('Error loading form:', error);
                $('#productModalBody').html('<div class="alert alert-danger">Lỗi khi tải form: ' + error.message + '</div>');
                $('#productModal').modal('show');
            });
        }

        // 3. HÀM CŨ: Xử lý submit form (Giữ nguyên)
        function attachFormSubmitHandler() {
            const form = $('#productModalBody form'); 
            form.on('submit', function(event) {
                event.preventDefault(); 
                
                const formData = new FormData(this);
                const url = $(this).attr('action');

                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...');

                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.headers.get('content-type') && response.headers.get('content-type').includes('application/json')) {
                        return response.json();
                    } else {
                        throw new Error('Lỗi Server: Không thể phân tích phản hồi JSON.');
                    }
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        $('#productModal').modal('hide'); 
                        window.location.reload(); 
                    } else {
                        alert('Thất bại: ' + data.message);
                        submitBtn.prop('disabled', false).text('Lưu'); 
                    }
                })
                .catch(error => {
                    console.error('Error submitting form:', error);
                    alert('Đã xảy ra lỗi khi gửi form: ' + error.message);
                    submitBtn.prop('disabled', false).text('Lưu');
                });
            });
        }
        
        // 4. HÀM CŨ: Xử lý xóa (Giữ nguyên)
        function handleDeleteProduct(id) {
            if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này không?')) {
                fetch('/admin/products/' + id, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Xóa sản phẩm thành công!');
                        window.location.reload(); 
                    } else {
                        alert('Lỗi: ' + (data.message || 'Không thể xóa sản phẩm.'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi trong quá trình xóa.');
                });
            }
        }
        /*]]>*/
    </script>
</div>
</html>